{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto mt-6">

  <!-- üîô Back to Dashboard -->
  <div class="mb-6">
    <a href="{% url 'manager_dashboard' %}" 
       class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 transition">
      ‚¨Ö Back to Dashboard
    </a>
  </div>

  <!-- üîç Search Bar -->
  <form method="get" action="{% url 'check_stock' %}" class="mb-6 flex gap-2">
    <input type="text" name="q" value="{{ query }}" 
           placeholder="üîé Search item..." 
           class="flex-grow border rounded px-4 py-2 shadow focus:outline-none focus:ring-2 focus:ring-blue-500">
    <button type="submit" 
            class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 transition">
      Search
    </button>
  </form>

  <!-- Combined Stock Block -->
  <div class="bg-white p-6 rounded shadow overflow-x-auto">
    <h2 class="text-xl font-bold mb-4">üì¶ Stock Overview</h2>

    {% if query %}
      <h3 class="text-lg font-semibold mb-2">üîç Search Results for "{{ query }}"</h3>
      {% if search_results %}
        <table class="w-full text-black table-auto border-collapse">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2 text-left">Category</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Unit</th>
              <th class="p-2 text-right">Buying Price</th>
              <th class="p-2 text-right">Selling Price</th>
              <th class="p-2 text-right">Stock Qty</th>
              <th class="p-2 text-right">Low Stock Threshold</th>
              <th class="p-2 text-left">Last Restocked</th>
              <th class="p-2 text-right">Total Sold</th>
              <th class="p-2 text-right">Revenue</th>
              <th class="p-2 text-right">Profit Margin</th>
            </tr>
          </thead>
          <tbody>
            {% for product in search_results %}
            <tr class="border-t hover:bg-gray-100">
              <td class="p-2">{{ product.category }}</td>
              <td class="p-2">{{ product.name }}</td>
              <td class="p-2">{{ product.unit }}</td>
              <td class="p-2 text-right">{{ product.buying_price }}</td>
              <td class="p-2 text-right">{{ product.selling_price }}</td>
              <td class="p-2 text-right">{{ product.stock_quantity }}</td>
              <td class="p-2 text-right">{{ product.low_stock_threshold }}</td>
              <td class="p-2">{{ product.last_restocked }}</td>
              <td class="p-2 text-right">{{ product.total_sold }}</td>
              <td class="p-2 text-right">{{ product.revenue }}</td>
              <td class="p-2 text-right">
                {% if product.profit > 0 %}
                  <span class="text-green-600 font-bold">+{{ product.profit }}</span>
                {% elif product.profit < 0 %}
                  <span class="text-red-600 font-bold">{{ product.profit }}</span>
                {% else %}
                  {{ product.profit }}
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="text-red-600">‚ö†Ô∏è No items found for "{{ query }}".</p>
      {% endif %}

    {% else %}
      {% for group in stock_data %}
        <h3 class="text-lg font-semibold mt-4 mb-2">{{ group.category.name }}</h3>
        <table class="w-full text-black table-auto border-collapse mb-4">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Unit</th>
              <th class="p-2 text-right">Buying Price</th>
              <th class="p-2 text-right">Selling Price</th>
              <th class="p-2 text-right">Stock Qty</th>
              <th class="p-2 text-right">Low Stock Threshold</th>
              <th class="p-2 text-left">Last Restocked</th>
              <th class="p-2 text-right">Total Sold</th>
              <th class="p-2 text-right">Revenue</th>
              <th class="p-2 text-right">Profit Margin</th>
            </tr>
          </thead>
          <tbody>
            {% for product in group.products %}
            <tr class="border-t hover:bg-gray-100">
              <td class="p-2">{{ product.name }}</td>
              <td class="p-2">{{ product.unit }}</td>
              <td class="p-2 text-right">{{ product.buying_price }}</td>
              <td class="p-2 text-right">{{ product.selling_price }}</td>
              <td class="p-2 text-right">{{ product.stock_quantity }}</td>
              <td class="p-2 text-right">{{ product.low_stock_threshold }}</td>
              <td class="p-2">{{ product.last_restocked }}</td>
              <td class="p-2 text-right">{{ product.total_sold }}</td>
              <td class="p-2 text-right">{{ product.revenue }}</td>
              <td class="p-2 text-right">
                {% if product.profit > 0 %}
                  <span class="text-green-600 font-bold">+{{ product.profit }}</span>
                {% elif product.profit < 0 %}
                  <span class="text-red-600 font-bold">{{ product.profit }}</span>
                {% else %}
                  {{ product.profit }}
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endfor %}
    {% endif %}

  </div>

</div>
{% endblock %}
