{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-6">Create New Sale</h1>
    
    <div id="sale-form-container" class="mb-6">
        <form id="sale-form" method="post">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Search Products</label>
                <input type="text" id="product-search" 
                       class="w-full px-3 py-2 border rounded" 
                       placeholder="Type product name...">
            </div>
            
            <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 mb-2">Selected Products</label>
                    <div id="selected-products" class="border rounded p-3 min-h-24">
                        <!-- Selected products will appear here -->
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Sale Summary</label>
                    <div class="border rounded p-3">
                        <div class="flex justify-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">UGX 0</span>
                        </div>
                        <div class="border-t pt-2">
                            <strong>Total:</strong>
                            <strong id="total-amount" class="float-right">UGX 0</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-right">
                <button type="submit" 
                        class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                    Complete Sale
                </button>
            </div>
        </form>
    </div>
    
    <div class="bg-gray-100 p-4 rounded">
        <h2 class="text-lg font-bold mb-3">Available Products</h2>
        <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
            {% for product in products %}
            <div class="product-item bg-white border rounded p-3 cursor-pointer hover:bg-blue-50"
                 data-id="{{ product.id }}"
                 data-name="{{ product.name }}"
                 data-price="{{ product.selling_price }}"
                 data-stock="{{ product.stock_quantity }}">
                <div class="font-bold">{{ product.name }}</div>
                <div class="text-gray-600">{{ product.category.name }}</div>
                <div class="flex justify-between mt-2">
                    <span>UGX {{ product.selling_price|floatformat:0|intcomma }}</span>
                    <span class="text-sm bg-gray-200 px-2 py-1 rounded">
                        Stock: {{ product.stock_quantity }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productItems = document.querySelectorAll('.product-item');
    const selectedContainer = document.getElementById('selected-products');
    const subtotalEl = document.getElementById('subtotal');
    const totalEl = document.getElementById('total-amount');
    const searchInput = document.getElementById('product-search');
    
    let selectedProducts = {};
    let subtotal = 0;
    
    // Add product to sale
    productItems.forEach(item => {
        item.addEventListener('click', function() {
            const id = this.dataset.id;
            const name = this.dataset.name;
            const price = parseFloat(this.dataset.price);
            const stock = parseInt(this.dataset.stock);
            
            if (!selectedProducts[id]) {
                // Check stock
                if (stock <= 0) {
                    alert(`${name} is out of stock!`);
                    return;
                }
                
                selectedProducts[id] = {
                    name: name,
                    price: price,
                    quantity: 1,
                    stock: stock
                };
                
                renderSelectedProducts();
                updateTotals();
            }
        });
    });
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        productItems.forEach(item => {
            const name = item.dataset.name.toLowerCase();
            if (name.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Render selected products
    function renderSelectedProducts() {
        selectedContainer.innerHTML = '';
        
        for (const id in selectedProducts) {
            const product = selectedProducts[id];
            const productEl = document.createElement('div');
            productEl.className = 'flex justify-between items-center border-b pb-2 mb-2';
            productEl.innerHTML = `
                <div>
                    <div class="font-medium">${product.name}</div>
                    <div class="text-sm text-gray-600">UGX ${product.price.toFixed(0)} x 
                        <input type="number" min="1" max="${product.stock}" 
                               value="${product.quantity}" 
                               class="quantity-input w-16 text-center border rounded"
                               data-id="${id}">
                    </div>
                </div>
                <div>
                    <span class="font-medium">UGX ${(product.price * product.quantity).toFixed(0)}</span>
                    <button class="remove-item ml-2 text-red-600 hover:text-red-800" data-id="${id}">
                        &times;
                    </button>
                </div>
            `;
            selectedContainer.appendChild(productEl);
        }
        
        // Add event listeners to quantity inputs
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function() {
                const id = this.dataset.id;
                const quantity = parseInt(this.value);
                
                if (quantity > 0 && quantity <= selectedProducts[id].stock) {
                    selectedProducts[id].quantity = quantity;
                    updateTotals();
                } else {
                    this.value = selectedProducts[id].quantity;
                    alert(`Quantity must be between 1 and ${selectedProducts[id].stock}`);
                }
            });
        });
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-item').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                delete selectedProducts[id];
                renderSelectedProducts();
                updateTotals();
            });
        });
    }
    
    // Update totals
    function updateTotals() {
        subtotal = 0;
        for (const id in selectedProducts) {
            subtotal += selectedProducts[id].price * selectedProducts[id].quantity;
        }
        
        subtotalEl.textContent = `UGX ${subtotal.toFixed(0)}`;
        totalEl.textContent = `UGX ${subtotal.toFixed(0)}`;
    }
    
    // Form submission
    document.getElementById('sale-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Add hidden inputs for selected products
        for (const id in selectedProducts) {
            const inputId = document.createElement('input');
            inputId.type = 'hidden';
            inputId.name = 'product';
            inputId.value = id;
            this.appendChild(inputId);
            
            const inputQty = document.createElement('input');
            inputQty.type = 'hidden';
            inputQty.name = 'quantity';
            inputQty.value = selectedProducts[id].quantity;
            this.appendChild(inputQty);
        }
        
        // Submit the form
        this.submit();
    });
});
</script>
{% endblock %}